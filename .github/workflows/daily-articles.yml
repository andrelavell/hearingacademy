name: Generate Daily Hearing Articles

on:
  schedule:
    # Default: run daily at 13:00 UTC (adjust as desired)
    - cron: '0 13 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
      OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-5' }}
      ARTICLES_PER_DAY: ${{ vars.ARTICLES_PER_DAY || 10' }}
      AUTHOR_NAME: ${{ vars.AUTHOR_NAME || 'HearingAcademy Editorial' }}
      TONE: ${{ vars.TONE || 'human, empathetic, fun, highly-educational' }}
      MIN_WORDS: ${{ vars.MIN_WORDS || '1000' }}
      MAX_WORDS: ${{ vars.MAX_WORDS || '1500' }}
      SITE_BASE_URL: ${{ vars.SITE_BASE_URL || 'https://hearingacademy.org' }}
      IMAGE_STORAGE: ${{ vars.IMAGE_STORAGE || 'local' }}
      IMAGE_STRICT_RELEVANCE: ${{ vars.IMAGE_STRICT_RELEVANCE || 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Scan existing articles
        run: npm run scan:articles

      - name: Validate env
        run: |
          missing=0
          for v in OPENAI_API_KEY PEXELS_API_KEY OPENAI_MODEL ARTICLES_PER_DAY SITE_BASE_URL IMAGE_STORAGE; do
            if [ -z "${!v}" ]; then
              echo "::error title=Missing env::${v} is not set"
              missing=1
            else
              echo "${v} is set"
            fi
          done
          exit $missing

      - name: Generate daily articles
        run: npm run generate:daily

      - name: Refresh article images (dedup + relevance)
        run: node scripts/refresh-article-images.js

      - name: Rescan articles for topics index (update images in listings)
        run: npm run scan:articles

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore: add daily generated articles"
            git push
          else
            echo "No changes to commit"
          fi
